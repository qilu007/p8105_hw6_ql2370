---
title: "HW6"
author: "QiLu"
date: "11/22/2019"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(modelr)

```

## Problem 1
```{r}
child_data = read.csv(file = "./data/birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    malform = as.factor(malform),
    mrace = as.factor(mrace)
  ) %>% 
  drop_na()
 
  
#child_data = map(child_data, as.factor) %>% 
#  as.tibble()
```
  
  Fit a linear model 
```{r}
bwt_full = lm(bwt ~ ., data = child_data)
summary(bwt_full)
```

Let's look at the p-value, at the 0.05 significant level, babysex, bhead, blength, delwt,gaweeks, mrace, parity and smoken are fail to reject the null hypothesis that coefficients are zero. However, an ANOVA test can optimize this model. I decided to test mom's race and parity which have higher p-value compared to others.

```{r, warning=FALSE}
# ANOVA test
bwt_lm = lm(bwt ~ babysex + bhead + blength + delwt + gaweeks + mrace + parity + smoken, data = child_data)
bwt_test = lm(bwt ~ babysex + bhead + blength + delwt + gaweeks + smoken, data = child_data)

anova(bwt_full, bwt_test) %>% 
  broom::tidy()

```
Therefore, we reject the null hypothesis. mom's race and parity can be included as predictors. I use bwt_lm as my linear model as the following
```{r}
summary(bwt_lm)
```
Showing the plot of model residuals against fitted values
```{r}

child_data %>% 
  modelr::add_residuals(bwt_lm) %>% 
  ggplot(aes(x = bwt, y = resid)) + geom_violin()

```


```{r}
cv_df = 
  crossv_mc(child_data, 50) 

cv_df %>% pull(train) %>% .[[3]] %>% as_tibble

cv_df =
  cv_df %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_df = 
  cv_df %>% 
  mutate(linear_mod = map(train, ~lm(bwt ~ babysex + bhead + blength + delwt + gaweeks + mrace + parity + smoken, data = child_data)),
         main_mod = map(train, ~lm(bwt ~ blength + gaweeks, data = child_data)),
         inter_mod = map(train, ~lm(bwt ~ bhead * blength * babysex, data = child_data)),
          rmse_linear = map2_dbl(.x = linear_mod, .y = test, ~rmse(.x, .y)),
    rmse_main = map2_dbl(.x = main_mod, .y = test, ~rmse(.x, .y)),
    rmse_inter = map2_dbl(inter_mod, test, ~rmse(model = .x, data = .y)))
```


```{r}
cv_result = cv_df %>% 
  select(rmse_linear, rmse_main, rmse_inter) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  as_tibble()


  ggplot(data = cv_result,aes(x = model, y = rmse)) + geom_violin()
```



